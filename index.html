<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>R√©gie Vid√©o - Panneau Tactile</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #1a1a1a;
    color: #ddd;
    font-family: 'Barlow', -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
    -webkit-user-select: none;
    user-select: none;
  }

  /* ===== MAIN 3-COLUMN LAYOUT ===== */
  .main {
    display: flex;
    width: 100%;
    height: 100%;
    gap: 8px;
    padding: 8px;
    overflow: hidden;
  }

  /* ===== LEFT COLUMN: PGM + Conducteur + Carousel ===== */
  .left {
    flex: 50;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-height: 0;
    min-width: 0;
  }

  .pgm-block {
    background: #1c2028;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    flex: 1 1 0;
    min-height: 0;
    overflow: hidden;
  }
  .pgm-screen {
    flex: 1 1 0;
    background: #000;
    border-radius: 12px 12px 0 0;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 0;
    position: relative;
  }
  .pgm-screen span { font-size: 2vw; font-weight: 600; color: rgba(255,255,255,0.4); letter-spacing: 4px; }
  .pgm-screen img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 12px 12px 0 0;
    display: none;
  }
  .pgm-screen video {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 12px 12px 0 0;
    display: none;
    background: #000;
  }
  .pgm-live-badge {
    position: absolute; top: 10px; left: 12px;
    background: #e00; color: #fff; font-size: 11px; font-weight: 800;
    padding: 3px 10px; border-radius: 4px; display: none; letter-spacing: 1px; z-index: 2;
  }
  .pgm-cam-label {
    position: absolute; top: 10px; right: 12px;
    color: #00c8ff; font-size: 13px; font-weight: 700; display: none; z-index: 2;
  }

  /* === SYNTH√â OVERLAY ON PGM === */
  .synthe-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 10;
    pointer-events: none;
    padding: 0;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.4s ease, transform 0.4s ease;
  }
  .synthe-overlay.visible {
    opacity: 1;
    transform: translateY(0);
  }
  .synthe-bandeau {
    background: linear-gradient(90deg, rgba(38,42,50,0.95) 0%, rgba(38,42,50,0.88) 40%, rgba(38,42,50,0.5) 70%, rgba(38,42,50,0) 100%);
    padding: 12px 40px 14px 16px;
    border-radius: 0 0 0 12px;
  }
  .synthe-nom {
    font-family: 'Barlow', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 20px;
    font-weight: 600;
    color: #fff;
    line-height: 1.2;
    letter-spacing: 0.2px;
  }
  .synthe-fonction {
    font-family: 'Barlow', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 13px;
    font-weight: 300;
    color: rgba(255,255,255,0.72);
    line-height: 1.35;
    margin-top: 1px;
  }
  .synthe-entreprise {
    font-family: 'Barlow', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 12px;
    font-weight: 300;
    color: rgba(255,255,255,0.55);
    line-height: 1.35;
  }

  .cam-pills { display: flex; gap: 4px; padding: 8px 8px 10px; flex-shrink: 0; }
  .cam-pill {
    flex: 1; height: 30px;
    background: #2c3240; border: 1.5px solid rgba(255,255,255,0.06); border-radius: 15px;
    color: #888; font-size: 11px; font-weight: 500; letter-spacing: 0.3px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
  }
  .cam-pill:hover { background: #3a4250; }
  .cam-pill.active { background: transparent; border-color: #00c8ff; color: #00c8ff; font-weight: 600; }

  /* Conducteur */
  .conducteur {
    background: #282c34; border-radius: 12px;
    padding: 8px 10px 10px; flex-shrink: 0;
  }
  .cond-title { text-align: center; font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 8px; letter-spacing: 0.3px; }
  .cond-items { display: flex; gap: 6px; }
  .cond-item {
    flex: 1; height: 46px;
    background: #333a44; border: 1.5px solid rgba(255,255,255,0.08); border-radius: 10px;
    display: flex; align-items: center; justify-content: center; gap: 5px;
    font-size: 10px; font-weight: 600; color: #bbb; letter-spacing: 0.3px;
    cursor: pointer; position: relative;
  }
  .cond-item:hover { border-color: rgba(255,255,255,0.15); background: #3a4250; }
  .cond-item.active { background: #00c8ff; border-color: #00c8ff; color: #000; }
  .cond-item .gear { position: absolute; top: 3px; right: 5px; font-size: 12px; opacity: 0.4; }
  .cond-item.active .gear { opacity: 0.6; color: #000; }
  .cond-icon {
    width: 26px; height: 26px;
    background: rgba(255,255,255,0.15);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    backdrop-filter: blur(4px);
  }
  .cond-item.active .cond-icon { background: rgba(0,0,0,0.15); }
  .cond-icon svg { width: 14px; height: 14px; stroke-width: 1.5; }

  /* Bottom left: carousel + tags */
  .bottom-left { display: flex; gap: 8px; flex-shrink: 0; overflow: hidden; min-width: 0; }
  .pages-panel {
    background: #282c34; border-radius: 12px; padding: 10px;
    flex: 1;
    min-width: 0;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
  }
  .pages-scroll {
    display: flex;
    gap: 8px;
    width: max-content;
  }
  .pages-panel::-webkit-scrollbar { height: 4px; }
  .pages-panel::-webkit-scrollbar-track { background: transparent; }
  .pages-panel::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }

  .content-card {
    width: 130px;
    height: 100px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    padding: 10px;
    cursor: pointer;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    border: 2px solid transparent;
    transition: all 0.2s;
  }
  .content-card:hover { transform: scale(1.03); }
  .content-card.selected { border-color: #00c8ff; box-shadow: 0 0 10px rgba(0,200,255,0.4); }
  .content-card .cc-title {
    font-size: 11px; font-weight: 700; color: #fff;
    text-transform: uppercase; line-height: 1.2; margin-bottom: 3px;
    overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    letter-spacing: 0.3px;
  }
  .content-card .cc-sub {
    font-size: 9px; font-weight: 400; color: rgba(255,255,255,0.7);
    text-transform: uppercase; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
    letter-spacing: 0.2px;
  }
  .content-card-empty {
    width: 130px; height: 100px; background: #333a44; border-radius: 10px;
    border: 2px dashed #4a5060; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; color: #555; font-size: 11px;
  }

  .right-tags { display: flex; flex-direction: column; gap: 6px; width: 220px; flex-shrink: 0; }
  .tag-row { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
  .tag {
    background: rgba(255,255,255,0.05); border: 1.5px solid rgba(255,255,255,0.08); border-radius: 16px;
    padding: 5px 12px; font-size: 11px; font-weight: 500; color: #aaa; cursor: pointer;
  }
  .tag:hover { border-color: rgba(255,255,255,0.15); }
  .tag.active { border-color: #00c8ff; color: #00c8ff; }
  .search-btn {
    width: 26px; height: 26px; background: rgba(255,255,255,0.05); border: 1.5px solid rgba(255,255,255,0.08);
    border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;
  }

  /* === SYNTH√âS PANEL (scrollable) === */
  .synthes-panel {
    background: #282c34;
    border-radius: 12px;
    padding: 8px 10px;
    flex-shrink: 0;
    max-height: 90px;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
  }
  .synthes-panel::-webkit-scrollbar { width: 3px; }
  .synthes-panel::-webkit-scrollbar-track { background: transparent; }
  .synthes-panel::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
  .synthes-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
  }
  .synthes-label {
    font-size: 10px;
    color: #555;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .synthes-count {
    font-size: 9px;
    color: #444;
    font-weight: 500;
  }
  .synthes-grid {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
  }
  .synthes-sep {
    width: 100%;
    height: 1px;
    background: rgba(255,255,255,0.06);
    margin: 4px 0 2px;
  }
  .synthe-pill.suggested {
    background: rgba(0,200,255,0.12);
    border-color: #00c8ff;
    color: #00e0ff;
  }
  .synthe-pill {
    background: rgba(0,180,240,0.08);
    border: 1.5px solid #00aadd;
    border-radius: 16px;
    padding: 5px 14px;
    font-size: 11px;
    font-weight: 600;
    color: #00c8ff;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .synthe-pill:hover {
    background: rgba(0,180,240,0.15);
  }
  .synthe-pill.on-air {
    background: rgba(224,0,0,0.15);
    border-color: #e00;
    color: #ff4444;
    animation: pulse-pill 1.5s ease-in-out infinite;
  }
  @keyframes pulse-pill {
    0%, 100% { box-shadow: 0 0 0 0 rgba(224,0,0,0); }
    50% { box-shadow: 0 0 8px 2px rgba(224,0,0,0.3); }
  }

  /* ===== CENTER COLUMN: Preview + Cam Grid + PTZ + Media ===== */
  .center {
    flex: 35;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-height: 0;
    overflow: hidden;
  }

  .preview-panel {
    background: #282c34; border-radius: 12px; padding: 8px;
    display: flex; flex-direction: column; gap: 6px; flex-shrink: 0;
  }
  .preview-screen {
    background: #000; border-radius: 8px; height: 20vh;
    position: relative; display: flex; align-items: center; justify-content: center;
  }
  .preview-screen span { font-size: 1.6vw; font-weight: 600; color: rgba(255,255,255,0.4); letter-spacing: 3px; }
  .preview-screen img {
    position: absolute; inset: 0; width: 100%; height: 100%;
    object-fit: cover; border-radius: 8px; display: none;
  }
  .zoom-ctrls { position: absolute; top: 6px; right: 6px; display: flex; flex-direction: column; gap: 3px; z-index: 2; }
  .zoom-btn {
    width: 32px; height: 32px; background: rgba(255,255,255,0.15); border: none; border-radius: 10px;
    color: #fff; font-size: 18px; font-weight: 500; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(4px);
  }
  .zoom-btn:hover { background: rgba(255,255,255,0.25); }
  .home-icon { position: absolute; bottom: 6px; left: 8px; cursor: pointer; z-index: 2; }

  .framing-bar { display: flex; gap: 3px; background: rgba(255,255,255,0.04); border-radius: 8px; padding: 3px; }
  .frame-slot {
    flex: 1; height: 38px; background: rgba(255,255,255,0.08); border-radius: 6px;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
  }
  .frame-slot:hover { background: rgba(255,255,255,0.12); }
  .frame-slot.active { background: #00c8ff; }
  .frame-slot svg .pf { fill: #999; }
  .frame-slot.active svg .pf { fill: #000; }

  /* Cam grid + D-pad */
  .cam-section { display: flex; gap: 8px; flex-shrink: 0; }
  .cam-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; flex: 1; }
  .cam-g {
    height: 40px; background: rgba(30,40,56,0.6); border: 1.5px solid rgba(255,255,255,0.06); border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 500; color: #7088aa; cursor: pointer;
  }
  .cam-g:hover { background: rgba(40,56,72,0.8); }
  .cam-g.active { background: #00c8ff; border-color: #00c8ff; color: #000; font-weight: 600; }
  .cam-g.empty { color: #334; }

  /* D-pad */
  .dpad { width: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; gap: 2px; }
  .dpad-row { display: flex; align-items: center; justify-content: center; gap: 2px; }
  .dpad-arrow {
    background: none; border: none; cursor: pointer; padding: 4px;
    display: flex; align-items: center; justify-content: center;
  }
  .dpad-arrow:hover svg path { stroke: #fff; }
  .dpad-center-btn {
    width: 38px; height: 38px; background: #00c8ff; border-radius: 50%; border: none;
    font-size: 10px; font-weight: 800; color: #000; cursor: pointer;
  }
  .dpad-x2 { font-size: 11px; font-weight: 700; color: #888; margin-top: 2px; }

  /* Media zone */
  .media-zone {
    display: flex;
    gap: 6px;
    flex: 1 1 0;
    min-height: 0;
  }
  .media-left {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .media-thumbs-row {
    display: flex;
    gap: 8px;
    flex: 1;
    min-height: 0;
    align-items: flex-start;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
  }
  .media-thumbs-row::-webkit-scrollbar { height: 3px; }
  .media-thumbs-row::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
  .m-wrap {
    display: flex; flex-direction: column; align-items: center; gap: 4px;
    width: 120px; flex-shrink: 0;
  }
  .m-thumb {
    width: 120px; height: 105px; border-radius: 12px;
    overflow: hidden; cursor: pointer; border: 3px solid transparent;
  }
  .m-thumb.sel { border-color: #00c8ff; box-shadow: 0 0 12px rgba(0,200,255,0.3); }
  .m-thumb.playing { border-color: #e00; box-shadow: 0 0 12px rgba(224,0,0,0.4); }
  .m-inner { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; }
  .gen-bg { position: absolute; inset: 0; background: linear-gradient(135deg, #1a2a4a 0%, #0a1828 100%); }
  .gen-icon { position: relative; z-index: 1; font-size: 26px; opacity: 0.9; }
  .m-label { font-size: 9px; color: #888; font-weight: 500; text-align: center; }

  .bottom-ctrls {
    display: flex; gap: 8px; flex-shrink: 0; height: 42px;
  }
  .bc {
    height: 100%; background: rgba(255,255,255,0.08); border: 1.5px solid rgba(255,255,255,0.06); border-radius: 12px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
  }
  .bc:hover { background: rgba(255,255,255,0.12); }
  .bc-demo { width: 60px; font-size: 12px; font-weight: 500; color: #ccc; }
  .bc-icon { width: 50px; }

  .media-right-btns {
    width: 90px; display: flex; flex-direction: column; gap: 6px; flex-shrink: 0;
  }
  .m-btn {
    flex: 1; border-radius: 10px; border: none;
    font-size: 11px; font-weight: 600; cursor: pointer; letter-spacing: 0.3px;
    display: flex; align-items: center; justify-content: center; gap: 5px;
  }
  .m-btn:hover { opacity: 0.85; }
  .m-btn.direct { background: #00c8ff; color: #000; }
  .m-btn.morning { background: rgba(255,255,255,0.12); color: #ccc; border: 1.5px solid rgba(255,255,255,0.08); }
  .m-btn.autres { background: rgba(255,255,255,0.12); color: #ccc; border: 1.5px solid rgba(255,255,255,0.08); }
  .m-btn-icon {
    width: 22px; height: 22px;
    background: rgba(255,255,255,0.15);
    border-radius: 7px;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(4px);
  }
  .m-btn.direct .m-btn-icon { background: rgba(0,0,0,0.12); }
  .m-btn.morning .m-btn-icon, .m-btn.autres .m-btn-icon { background: rgba(255,255,255,0.12); }
  .m-btn-icon svg { width: 12px; height: 12px; stroke-width: 1.5; }

  /* ===== RIGHT COLUMN: Calendar Timeline ===== */
  .calendar-col {
    width: 180px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .cal-header {
    font-size: 16px;
    font-weight: 700;
    color: #fff;
    padding: 8px 0 6px;
    flex-shrink: 0;
    letter-spacing: 0.3px;
  }

  .cal-timeline {
    flex: 1;
    position: relative;
    overflow-y: auto;
    overflow-x: hidden;
  }
  .cal-timeline::-webkit-scrollbar { width: 3px; }
  .cal-timeline::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

  .cal-timeline-inner {
    position: relative;
    width: 100%;
  }

  .cal-hour-row {
    height: 60px;
    border-top: 1px solid #2a2e36;
    position: relative;
    display: flex;
    align-items: flex-start;
  }
  .cal-hour-label {
    font-size: 9px;
    font-weight: 600;
    color: #556;
    width: 32px;
    flex-shrink: 0;
    padding-top: 2px;
    text-align: right;
    padding-right: 6px;
  }

  .cal-events-area {
    position: absolute;
    left: 34px;
    right: 0;
    top: 0;
    bottom: 0;
  }

  .cal-ev {
    position: absolute;
    left: 0;
    right: 4px;
    background: #282c34;
    border-left: 3px solid #00c8ff;
    border-radius: 4px;
    padding: 4px 6px;
    cursor: pointer;
    overflow: hidden;
    z-index: 2;
    transition: background 0.2s;
  }
  .cal-ev:hover { background: #2e3340; }
  .cal-ev.active { background: rgba(0,200,255,0.12); border-left-color: #00c8ff; }
  .cal-ev.past { opacity: 0.4; border-left-color: #555; }
  .cal-ev .cal-ev-time { font-size: 8px; font-weight: 700; color: #00c8ff; margin-bottom: 1px; }
  .cal-ev.past .cal-ev-time { color: #666; }
  .cal-ev .cal-ev-title { font-size: 10px; font-weight: 700; color: #ccc; line-height: 1.2; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
  .cal-ev.past .cal-ev-title { color: #888; }

  .cal-now-line {
    position: absolute; left: 28px; right: 0; height: 2px; background: #00c8ff; z-index: 5; pointer-events: none;
  }
  .cal-now-line::before {
    content: ''; position: absolute; left: -4px; top: -3px; width: 8px; height: 8px; background: #00c8ff; border-radius: 50%;
  }
  .cal-now-label {
    position: absolute; left: 0; top: -6px; font-size: 8px; font-weight: 800; color: #00c8ff; z-index: 6; pointer-events: none;
  }
</style>
</head>
<body>
<div class="main">

  <!-- ===== LEFT COLUMN ===== -->
  <div class="left">
    <div class="pgm-block">
      <div class="pgm-screen" id="pgmScreen">
        <span id="pgmLabel">PGM</span>
        <img id="pgmStream" alt="">
        <video id="pgmVideo" playsinline preload="auto"></video>
        <div class="pgm-live-badge" id="pgmLive">‚óè LIVE</div>
        <div class="pgm-cam-label" id="pgmCamLabel"></div>
        <!-- SYNTH√â OVERLAY -->
        <div class="synthe-overlay" id="syntheOverlay">
          <div class="synthe-bandeau">
            <div class="synthe-nom" id="syntheNom"></div>
            <div class="synthe-fonction" id="syntheFonction"></div>
            <div class="synthe-entreprise" id="syntheEntreprise"></div>
          </div>
        </div>
      </div>
      <div class="cam-pills" id="camPills">
        <div class="cam-pill" data-cam="1">CAM 1</div>
        <div class="cam-pill" data-cam="2">CAM 2</div>
        <div class="cam-pill" data-cam="3">CAM 3</div>
        <div class="cam-pill" data-cam="4">CAM 4</div>
        <div class="cam-pill" data-cam="5">CAM 5</div>
        <div class="cam-pill" data-cam="6">CAM 6</div>
        <div class="cam-pill" data-cam="7">CAM 7</div>
        <div class="cam-pill" data-cam="8">CAM 8</div>
      </div>
    </div>

    <div class="conducteur">
      <div class="cond-title">Mardi 10 f√©vrier</div>
      <div class="cond-items">
        <div class="cond-item"><div class="cond-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></div>UNIVERSAL<span class="gear">‚öô</span></div>
        <div class="cond-item active"><div class="cond-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></div>REXEL<span class="gear">‚öô</span></div>
        <div class="cond-item"><div class="cond-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></div>REMY<span class="gear">‚öô</span></div>
        <div class="cond-item"><div class="cond-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg></div>POINT TAUX<span class="gear">‚öô</span></div>
        <div class="cond-item"><div class="cond-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>√âCLAIREUR<span class="gear">‚öô</span></div>
      </div>
    </div>

    <div class="bottom-left">
      <div class="pages-panel" id="pagesPanel">
        <div class="pages-scroll" id="pagesScroll">
          <div class="content-card-empty">Chargement...</div>
        </div>
      </div>
      <div class="right-tags">
        <div class="tag-row">
          <span class="tag active">Actions</span>
          <span class="tag">Eco</span>
          <span class="tag">Autre</span>
          <div class="search-btn">
            <svg width="12" height="12" viewBox="0 0 24 24"><circle cx="10" cy="10" r="7" fill="none" stroke="#888" stroke-width="2.5"/><line x1="15" y1="15" x2="21" y2="21" stroke="#888" stroke-width="2.5" stroke-linecap="round"/></svg>
          </div>
        </div>
        <div class="tag-row">
          <span class="tag">Alexandre g</span>
          <span class="tag">Herv√©</span>
          <span class="tag">Jluc</span>
        </div>
      </div>
    </div>

    <!-- SYNTH√âS PANEL (scrollable) -->
    <div class="synthes-panel" id="synthesPanel">
      <div class="synthes-header">
        <span class="synthes-label">Synth√©s</span>
        <span class="synthes-count" id="synthesCount"></span>
      </div>
      <div class="synthes-grid" id="synthesGrid">
        <span style="font-size:10px;color:#444;">Chargement contacts...</span>
      </div>
    </div>
  </div>

  <!-- ===== CENTER COLUMN ===== -->
  <div class="center">
    <div class="preview-panel">
      <div class="preview-screen">
        <span id="previewLabel">CAM 1</span>
        <img id="previewStream" alt="">
        <div class="zoom-ctrls">
          <button class="zoom-btn">+</button>
          <button class="zoom-btn">‚àí</button>
        </div>
        <div class="home-icon">
          <svg width="24" height="24" viewBox="0 0 32 32" fill="none">
            <path d="M6 16L16 6l10 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 14v12a1 1 0 001 1h5v-7h4v7h5a1 1 0 001-1V14" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      <div class="framing-bar">
        <div class="frame-slot"><svg width="12" height="26" viewBox="0 0 14 28"><circle cx="7" cy="5" r="4" class="pf"/><rect x="1.5" y="12" width="11" height="14" rx="2.5" class="pf"/></svg></div>
        <div class="frame-slot active"><svg width="22" height="26" viewBox="0 0 26 28"><circle cx="8" cy="5" r="3.8" class="pf"/><rect x="2" y="12" width="12" height="14" rx="2.5" class="pf"/><circle cx="19" cy="6" r="3.2" class="pf"/><rect x="14" y="13" width="10" height="13" rx="2" class="pf"/></svg></div>
        <div class="frame-slot"><svg width="26" height="26" viewBox="0 0 30 28"><circle cx="6" cy="6" r="3" class="pf"/><rect x="1" y="12" width="10" height="14" rx="2" class="pf"/><circle cx="15" cy="5" r="3.5" class="pf"/><rect x="9.5" y="11" width="11" height="15" rx="2" class="pf"/><circle cx="24" cy="6" r="3" class="pf"/><rect x="19" y="12" width="10" height="14" rx="2" class="pf"/></svg></div>
        <div class="frame-slot"><svg width="30" height="26" viewBox="0 0 34 28"><circle cx="5" cy="7" r="2.8" class="pf"/><rect x="1" y="13" width="8" height="13" rx="1.8" class="pf"/><circle cx="13" cy="6" r="3" class="pf"/><rect x="8.5" y="12" width="9" height="14" rx="2" class="pf"/><circle cx="22" cy="6" r="3" class="pf"/><rect x="17.5" y="12" width="9" height="14" rx="2" class="pf"/><circle cx="30" cy="7" r="2.8" class="pf"/><rect x="26" y="13" width="8" height="13" rx="1.8" class="pf"/></svg></div>
        <div class="frame-slot"><svg width="34" height="26" viewBox="0 0 38 28"><circle cx="4" cy="7" r="2.5" class="pf"/><rect x="0.5" y="13" width="7" height="12" rx="1.5" class="pf"/><circle cx="11" cy="6.5" r="2.8" class="pf"/><rect x="6.5" y="12.5" width="9" height="13" rx="1.8" class="pf"/><circle cx="19" cy="6" r="3" class="pf"/><rect x="14.5" y="12" width="9" height="14" rx="2" class="pf"/><circle cx="27" cy="6.5" r="2.8" class="pf"/><rect x="22.5" y="12.5" width="9" height="13" rx="1.8" class="pf"/><circle cx="34" cy="7" r="2.5" class="pf"/><rect x="30.5" y="13" width="7" height="12" rx="1.5" class="pf"/></svg></div>
        <div class="frame-slot"><svg width="36" height="26" viewBox="0 0 44 28"><circle cx="4" cy="7.5" r="2.2" class="pf"/><rect x="1" y="13.5" width="6" height="11" rx="1.3" class="pf"/><circle cx="11" cy="7" r="2.5" class="pf"/><rect x="7" y="13" width="8" height="12" rx="1.5" class="pf"/><circle cx="19" cy="6.5" r="2.8" class="pf"/><rect x="14.5" y="12.5" width="9" height="13" rx="1.8" class="pf"/><circle cx="27" cy="6.5" r="2.8" class="pf"/><rect x="22.5" y="12.5" width="9" height="13" rx="1.8" class="pf"/><circle cx="34" cy="7" r="2.5" class="pf"/><rect x="30" y="13" width="8" height="12" rx="1.5" class="pf"/><circle cx="41" cy="7.5" r="2.2" class="pf"/><rect x="38" y="13.5" width="6" height="11" rx="1.3" class="pf"/></svg></div>
        <div class="frame-slot"><svg width="12" height="26" viewBox="0 0 14 28"><circle cx="7" cy="5" r="4" class="pf"/><rect x="1.5" y="12" width="11" height="14" rx="2.5" class="pf"/></svg></div>
      </div>
    </div>

    <div class="cam-section">
      <div class="cam-grid">
        <div class="cam-g" data-cam="3">CAM 3</div>
        <div class="cam-g" data-cam="6">CAM 6</div>
        <div class="cam-g empty">‚Äî</div>
        <div class="cam-g" data-cam="2">CAM 2</div>
        <div class="cam-g" data-cam="5">CAM 5</div>
        <div class="cam-g" data-cam="8">CAM 8</div>
        <div class="cam-g active" data-cam="1">CAM 1</div>
        <div class="cam-g" data-cam="4">CAM 4</div>
        <div class="cam-g" data-cam="7">CAM 7</div>
      </div>
      <div class="dpad">
        <div class="dpad-row">
          <button class="dpad-arrow" data-dir="up"><svg width="30" height="22" viewBox="0 0 30 22" fill="none"><path d="M15 3L26 19H4L15 3Z" stroke="#fff" stroke-width="1.5" stroke-linejoin="round"/></svg></button>
        </div>
        <div class="dpad-row">
          <button class="dpad-arrow" data-dir="left"><svg width="22" height="30" viewBox="0 0 22 30" fill="none"><path d="M3 15L19 4V26L3 15Z" stroke="#fff" stroke-width="1.5" stroke-linejoin="round"/></svg></button>
          <button class="dpad-center-btn">slow</button>
          <button class="dpad-arrow" data-dir="right"><svg width="22" height="30" viewBox="0 0 22 30" fill="none"><path d="M19 15L3 4V26L19 15Z" stroke="#fff" stroke-width="1.5" stroke-linejoin="round"/></svg></button>
        </div>
        <div class="dpad-row" style="flex-direction:column;align-items:center;">
          <button class="dpad-arrow" data-dir="down"><svg width="30" height="22" viewBox="0 0 30 22" fill="none"><path d="M15 19L4 3H26L15 19Z" stroke="#fff" stroke-width="1.5" stroke-linejoin="round"/></svg></button>
          <span class="dpad-x2">x2</span>
        </div>
      </div>
    </div>

    <div class="media-zone">
      <div class="media-left">
        <div class="media-thumbs-row" id="genThumbs"></div>
        <div class="bottom-ctrls">
          <button class="bc bc-demo">D√©mo</button>
          <button class="bc bc-icon">
            <svg width="20" height="22" viewBox="0 0 22 24" fill="none"><path d="M4 2L19 12L4 22V2Z" stroke="#ccc" stroke-width="1.5" stroke-linejoin="round"/></svg>
          </button>
          <button class="bc bc-icon">
            <svg width="22" height="20" viewBox="0 0 24 22" fill="none"><path d="M2 1h20v13H8L2 20V1Z" stroke="#ccc" stroke-width="1.5" stroke-linejoin="round"/></svg>
          </button>
          <button class="bc bc-icon">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 3v13M12 16l-5-5M12 16l5-5" stroke="#ccc" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><rect x="3" y="18" width="18" height="3" rx="1.5" stroke="#ccc" stroke-width="1.5"/></svg>
          </button>
        </div>
      </div>
      <div class="media-right-btns">
        <button class="m-btn direct"><div class="m-btn-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M16.24 7.76a6 6 0 010 8.49"/><path d="M19.07 4.93a10 10 0 010 14.14"/></svg></div>DIRECT</button>
        <button class="m-btn morning"><div class="m-btn-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/></svg></div>MORNING</button>
        <button class="m-btn autres"><div class="m-btn-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></div>AUTRES</button>
      </div>
    </div>
  </div>

  <!-- ===== RIGHT COLUMN: Calendar Timeline ===== -->
  <div class="calendar-col">
    <div class="cal-header" id="calHeader"></div>
    <div class="cal-timeline" id="calTimeline">
      <div class="cal-timeline-inner" id="calTimelineInner"></div>
    </div>
  </div>

</div>

<script>
  // ===== CONFIGURATION =====
  var CAMERA_IP = '192.168.1.54';
  var WS_SERVER = 'https://ecamm-overlay-server.onrender.com';
  var GH_REPO = 'lezenesvincent-dotcom/mon-content-manager';
  var camSources = {
    1: 'https://admin:Axians123@' + CAMERA_IP + '/image3',
    2: null, 3: null, 4: null, 5: null, 6: null, 7: null, 8: null
  };

  var activePgmCam = null;
  var activePreviewCam = null;
  var ptzSpeed = 5;
  var selectedContentId = null;
  var contacts = [];
  var activeSynthe = null;
  var todayIntervenants = [];
  var ws = null;

  // ===== WEBSOCKET FOR SYNTH√â SYNC =====
  function connectSyntheWS() {
    var wsUrl = WS_SERVER.replace('https://', 'wss://').replace('http://', 'ws://');
    ws = new WebSocket(wsUrl);
    ws.onopen = function() { console.log('üü¢ Synth√© WS connect√©'); };
    ws.onclose = function() { setTimeout(connectSyntheWS, 3000); };
    ws.onerror = function() {};
  }
  connectSyntheWS(); // contact IDs detected from today's fiches

  // ===== LOAD CONTACTS FROM GITHUB =====
  async function loadContactsData() {
    try {
      var resp = await fetch('https://raw.githubusercontent.com/' + GH_REPO + '/main/contacts.json', { cache: 'no-store' });
      if (resp.ok) {
        contacts = await resp.json();
      }
    } catch(e) {
      try {
        var r2 = await fetch('https://api.github.com/repos/' + GH_REPO + '/contents/contacts.json', {
          headers: { 'Accept': 'application/vnd.github.v3+json' }
        });
        if (r2.ok) {
          var d = await r2.json();
          contacts = JSON.parse(decodeURIComponent(escape(atob(d.content))));
        }
      } catch(e2) { console.error('Contacts fallback error:', e2); }
    }
  }

  // ===== LOAD TODAY'S FICHES ‚Üí DETECT INTERVENANTS =====
  async function loadTodayFiches() {
    try {
      var resp = await fetch(WS_SERVER + '/api/fiches');
      if (!resp.ok) return;
      var fiches = await resp.json();
      var today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

      todayIntervenants = [];

      Object.values(fiches).forEach(function(fiche) {
        // Match fiches for today
        if (fiche.date !== today) return;

        // Extract intervenants from fiche
        var intervs = fiche.intervenants || [];
        intervs.forEach(function(interv) {
          var nom = (interv.nom || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
          var prenom = (interv.prenom || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

          // Match with contacts
          contacts.forEach(function(c) {
            var cNom = (c.lastName || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            var cPrenom = (c.firstName || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

            if (cNom && nom && cNom === nom) {
              if (!todayIntervenants.includes(c.id)) {
                todayIntervenants.push(c.id);
              }
            } else if (cNom && cPrenom && nom === cNom && prenom === cPrenom) {
              if (!todayIntervenants.includes(c.id)) {
                todayIntervenants.push(c.id);
              }
            }
          });
        });
      });
    } catch(e) {
      console.error('Fiches load error:', e);
    }
  }

  // ===== INIT: load contacts then fiches then build pills =====
  async function initSynthes() {
    await loadContactsData();
    await loadTodayFiches();
    buildSynthePills();
  }

  // ===== BUILD SYNTH√â PILLS =====
  function buildSynthePills() {
    var grid = document.getElementById('synthesGrid');
    var countEl = document.getElementById('synthesCount');
    grid.innerHTML = '';

    if (!contacts || contacts.length === 0) {
      grid.innerHTML = '<span style="font-size:10px;color:#444;">Aucun contact</span>';
      countEl.textContent = '';
      return;
    }

    var sorted = contacts.slice().sort(function(a, b) {
      return (a.lastName || '').localeCompare(b.lastName || '');
    });

    // Split: today's intervenants first, then the rest
    var suggested = sorted.filter(function(c) { return todayIntervenants.includes(c.id); });
    var others = sorted.filter(function(c) { return !todayIntervenants.includes(c.id); });

    if (suggested.length > 0) {
      countEl.textContent = suggested.length + ' du jour / ' + sorted.length + ' total';
    } else {
      countEl.textContent = '(' + sorted.length + ')';
    }

    // Render suggested first
    suggested.forEach(function(c) {
      var pill = createPill(c, true);
      grid.appendChild(pill);
    });

    // Separator if there are suggested contacts
    if (suggested.length > 0 && others.length > 0) {
      var sep = document.createElement('div');
      sep.className = 'synthes-sep';
      grid.appendChild(sep);
    }

    // Render others
    others.forEach(function(c) {
      var pill = createPill(c, false);
      grid.appendChild(pill);
    });
  }

  function createPill(contact, isSuggested) {
    var pill = document.createElement('span');
    pill.className = 'synthe-pill';
    if (isSuggested) pill.classList.add('suggested');
    pill.textContent = contact.firstName + ' ' + contact.lastName;
    pill.dataset.contactId = contact.id;

    if (activeSynthe === contact.id) pill.classList.add('on-air');

    pill.addEventListener('click', function() {
      toggleSynthe(contact);
    });

    return pill;
  }

  // ===== TOGGLE SYNTH√â ON/OFF =====
  function toggleSynthe(contact) {
    var overlay = document.getElementById('syntheOverlay');

    if (activeSynthe === contact.id) {
      // Turn OFF
      overlay.classList.remove('visible');
      activeSynthe = null;
      document.querySelectorAll('.synthe-pill').forEach(function(p) {
        p.classList.remove('on-air');
      });
      // Send OFF to output page
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'synthe_update', data: null }));
      }
      return;
    }

    // Turn ON
    activeSynthe = contact.id;

    document.getElementById('syntheNom').textContent = contact.firstName + ' ' + contact.lastName;
    document.getElementById('syntheFonction').textContent = contact.function || '';
    document.getElementById('syntheEntreprise').textContent = contact.company || '';

    overlay.classList.remove('visible');
    requestAnimationFrame(function() {
      requestAnimationFrame(function() {
        overlay.classList.add('visible');
      });
    });

    document.querySelectorAll('.synthe-pill').forEach(function(p) {
      if (p.dataset.contactId === contact.id) {
        p.classList.add('on-air');
      } else {
        p.classList.remove('on-air');
      }
    });

    // Send to output page
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({
        type: 'synthe_update',
        data: {
          nom: contact.firstName + ' ' + contact.lastName,
          fonction: contact.function || '',
          entreprise: contact.company || ''
        }
      }));
    }
  }

  // Load synth√©s on startup
  initSynthes();
  // Refresh every 2 minutes
  setInterval(initSynthes, 120000);

  // ===== OVERLAY CONTENTS =====
  function loadContents() {
    fetch(WS_SERVER + '/history')
      .then(function(r) { return r.json(); })
      .then(function(history) {
        var scroll = document.getElementById('pagesScroll');
        scroll.innerHTML = '';

        if (!history || history.length === 0) {
          scroll.innerHTML = '<div class="content-card-empty">Aucun contenu</div>';
          return;
        }

        var seen = {};
        var unique = [];
        history.forEach(function(item) {
          var key = item.titre || item.title || 'Sans titre';
          if (!seen[key]) {
            seen[key] = true;
            unique.push(item);
          }
        });

        unique.forEach(function(item) {
          var card = document.createElement('div');
          card.className = 'content-card';
          if (item.id === selectedContentId) card.classList.add('selected');

          var title = item.titre || item.title || 'Sans titre';
          var sub = item.soustitre || item.subtitle || '';
          if (!sub && item.p1 && item.p1.sujet) sub = item.p1.sujet;

          card.innerHTML = '<div class="cc-title">' + title + '</div><div class="cc-sub">' + sub + '</div>';

          card.addEventListener('click', function() {
            selectContent(item);
            document.querySelectorAll('.content-card').forEach(function(c) { c.classList.remove('selected'); });
            card.classList.add('selected');
          });

          scroll.appendChild(card);
        });
      })
      .catch(function() {
        document.getElementById('pagesScroll').innerHTML = '<div class="content-card-empty">Serveur hors ligne</div>';
      });
  }

  function selectContent(item) {
    selectedContentId = item.id;
    fetch(WS_SERVER + '/api/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        titre: item.titre || item.title || '',
        soustitre: item.soustitre || item.subtitle || '',
        p1: item.p1 || { sujet: '', contenu: [] },
        p2: item.p2 || { sujet: '', contenu: [] },
        p3: item.p3 || { sujet: '', contenu: [] },
        p4: item.p4 || { sujet: '', contenu: [] }
      })
    });
  }

  loadContents();
  setInterval(loadContents, 30000);

  // ===== CAMERA COMMANDS =====
  function sendCmd(cgi, params) {
    var query = Object.entries(params).map(function(p) { return p[0] + '=' + p[1]; }).join('&');
    var url = 'https://' + CAMERA_IP + '/command/' + cgi + '?' + query;
    var img = new Image();
    img.src = url;
  }

  // ===== PTZ =====
  function ptzMove(direction) {
    var s = ptzSpeed;
    if (direction === 'up') sendCmd('ptzf.cgi', { PanTiltMove: 'up,0,' + s });
    if (direction === 'down') sendCmd('ptzf.cgi', { PanTiltMove: 'down,0,' + s });
    if (direction === 'left') sendCmd('ptzf.cgi', { PanTiltMove: 'left,' + s + ',0' });
    if (direction === 'right') sendCmd('ptzf.cgi', { PanTiltMove: 'right,' + s + ',0' });
  }

  function ptzStop() {
    sendCmd('ptzf.cgi', { PanTiltMove: 'stop,0,0' });
  }

  // ===== D-PAD =====
  document.querySelectorAll('.dpad-arrow').forEach(function(arrow) {
    var dir = arrow.getAttribute('data-dir');
    if (!dir) return;
    arrow.addEventListener('mousedown', function(e) { e.preventDefault(); ptzMove(dir); });
    arrow.addEventListener('touchstart', function(e) { e.preventDefault(); ptzMove(dir); });
    arrow.addEventListener('mouseup', ptzStop);
    arrow.addEventListener('mouseleave', ptzStop);
    arrow.addEventListener('touchend', ptzStop);
  });

  document.querySelector('.dpad-center-btn').addEventListener('click', function() {
    if (ptzSpeed === 5) {
      ptzSpeed = 20;
      this.textContent = 'fast';
      this.style.background = '#ff6600';
    } else {
      ptzSpeed = 5;
      this.textContent = 'slow';
      this.style.background = '#00c8ff';
    }
  });

  // ===== ZOOM =====
  document.querySelectorAll('.zoom-btn').forEach(function(btn) {
    var dir = btn.textContent.trim() === '+' ? 'tele' : 'wide';
    btn.addEventListener('mousedown', function(e) { e.preventDefault(); sendCmd('ptzf.cgi', { ZoomMove: dir + ',5000' }); });
    btn.addEventListener('mouseup', function() { sendCmd('ptzf.cgi', { ZoomMove: 'stop,0' }); });
    btn.addEventListener('mouseleave', function() { sendCmd('ptzf.cgi', { ZoomMove: 'stop,0' }); });
    btn.addEventListener('touchstart', function(e) { e.preventDefault(); sendCmd('ptzf.cgi', { ZoomMove: dir + ',5000' }); });
    btn.addEventListener('touchend', function() { sendCmd('ptzf.cgi', { ZoomMove: 'stop,0' }); });
  });

  // ===== HOME =====
  document.querySelector('.home-icon').addEventListener('click', function() {
    sendCmd('presetposition.cgi', { HomePos: 'recall' });
  });

  // ===== CAM PILLS ‚Üí PGM =====
  document.querySelectorAll('.cam-pill').forEach(function(pill) {
    pill.addEventListener('click', function() {
      selectPgmCam(parseInt(pill.dataset.cam));
    });
  });

  function selectPgmCam(camNum) {
    var pgmLabel = document.getElementById('pgmLabel');
    var pgmStream = document.getElementById('pgmStream');
    var pgmLive = document.getElementById('pgmLive');
    var pgmCamLabel = document.getElementById('pgmCamLabel');

    document.querySelectorAll('.cam-pill').forEach(function(p) { p.classList.remove('active'); });
    document.querySelector('.cam-pill[data-cam="' + camNum + '"]').classList.add('active');
    activePgmCam = camNum;

    var src = camSources[camNum];
    if (src) {
      pgmLabel.style.display = 'none';
      pgmStream.src = src;
      pgmStream.style.display = 'block';
      pgmLive.style.display = 'block';
      pgmCamLabel.textContent = 'CAM ' + camNum;
      pgmCamLabel.style.display = 'block';
    } else {
      pgmStream.style.display = 'none';
      pgmStream.src = '';
      pgmLive.style.display = 'none';
      pgmCamLabel.style.display = 'none';
      pgmLabel.style.display = 'block';
      pgmLabel.textContent = 'CAM ' + camNum;
      pgmLabel.style.color = '#aaa';
    }
  }

  // ===== CAM GRID ‚Üí PREVIEW =====
  document.querySelectorAll('.cam-g').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var camNum = btn.dataset.cam;
      if (!camNum) return;
      selectPreviewCam(parseInt(camNum));
    });
  });

  function selectPreviewCam(camNum) {
    var previewLabel = document.getElementById('previewLabel');
    var previewStream = document.getElementById('previewStream');

    document.querySelectorAll('.cam-g').forEach(function(g) { g.classList.remove('active'); });
    document.querySelector('.cam-g[data-cam="' + camNum + '"]').classList.add('active');
    activePreviewCam = camNum;

    var src = camSources[camNum];
    if (src) {
      previewLabel.style.display = 'none';
      previewStream.src = src;
      previewStream.style.display = 'block';
    } else {
      previewStream.style.display = 'none';
      previewStream.src = '';
      previewLabel.style.display = 'block';
      previewLabel.textContent = 'CAM ' + camNum;
      previewLabel.style.color = '#aaa';
    }
  }

  // ===== G√âN√âRIQUES =====
  var RENDER_SERVER = 'https://ecamm-overlay-server.onrender.com';
  var generiques = [
    { nom: 'GEN - Ligne M√©tier Communication', url: RENDER_SERVER + '/videos/gen-communication.mov' },
    { nom: 'GEN - Morning', url: RENDER_SERVER + '/videos/morning-2026-v1.mp4' }
  ];

  var pgmVideo = document.getElementById('pgmVideo');

  function buildGenThumbs() {
    var container = document.getElementById('genThumbs');
    container.innerHTML = '';
    generiques.forEach(function(gen, i) {
      var wrap = document.createElement('div');
      wrap.className = 'm-wrap';
      wrap.innerHTML = '<div class="m-thumb" data-gen="' + i + '"><div class="m-inner"><div class="gen-bg"></div><span class="gen-icon">‚ñ∂</span></div></div><span class="m-label">' + gen.nom + '</span>';
      wrap.querySelector('.m-thumb').addEventListener('click', function() {
        playGenerique(i);
      });
      container.appendChild(wrap);
    });
  }
  buildGenThumbs();

  if (generiques.length > 0) {
    pgmVideo.src = generiques[0].url;
    pgmVideo.load();
  }

  function playGenerique(index) {
    var gen = generiques[index];
    var pgmLabel = document.getElementById('pgmLabel');
    var pgmStream = document.getElementById('pgmStream');
    var pgmLive = document.getElementById('pgmLive');
    var pgmCamLabel = document.getElementById('pgmCamLabel');

    pgmStream.style.display = 'none';
    pgmStream.src = '';
    pgmLabel.style.display = 'none';
    pgmLive.style.display = 'none';
    pgmCamLabel.style.display = 'none';

    document.querySelectorAll('.cam-pill').forEach(function(p) { p.classList.remove('active'); });
    activePgmCam = null;

    document.querySelectorAll('.m-thumb').forEach(function(t) { t.classList.remove('playing'); });
    var thumb = document.querySelector('.m-thumb[data-gen="' + index + '"]');
    if (thumb) thumb.classList.add('playing');

    pgmVideo.src = gen.url;
    pgmVideo.load();
    pgmVideo.style.display = 'block';
    pgmVideo.play();
  }

  pgmVideo.addEventListener('ended', function() {
    pgmVideo.style.display = 'none';
    document.querySelectorAll('.m-thumb').forEach(function(t) { t.classList.remove('playing'); });
    document.getElementById('pgmLabel').style.display = 'block';
    document.getElementById('pgmLabel').textContent = 'PGM';
    document.getElementById('pgmLabel').style.color = '#aaa';
  });

  var origSelectPgmCam = selectPgmCam;
  selectPgmCam = function(camNum) {
    pgmVideo.pause();
    pgmVideo.style.display = 'none';
    pgmVideo.src = '';
    document.querySelectorAll('.m-thumb').forEach(function(t) { t.classList.remove('playing'); });
    origSelectPgmCam(camNum);
  };

  // ===== ERREURS STREAM =====
  document.getElementById('pgmStream').addEventListener('error', function() {
    document.getElementById('pgmStream').style.display = 'none';
    document.getElementById('pgmLive').style.display = 'none';
    var l = document.getElementById('pgmLabel');
    l.style.display = 'block';
    l.textContent = 'CAM ' + activePgmCam + ' ‚Äî pas de signal';
    l.style.color = '#c44';
  });

  document.getElementById('previewStream').addEventListener('error', function() {
    document.getElementById('previewStream').style.display = 'none';
    var l = document.getElementById('previewLabel');
    l.style.display = 'block';
    l.textContent = 'CAM ' + activePreviewCam + ' ‚Äî pas de signal';
    l.style.color = '#c44';
  });

  // ===== CALENDAR TIMELINE =====
  var CAL_START = 8;
  var CAL_END = 19;
  var HOUR_HEIGHT = 60;
  var calEvents = [];

  // Load real calendar data from GitHub (synced from Exchange every 5 min)
  async function loadCalendarData() {
    try {
      var resp = await fetch('https://raw.githubusercontent.com/' + GH_REPO + '/main/calendar-data.json', { cache: 'no-store' });
      if (!resp.ok) return;
      var data = await resp.json();

      // calendar-data.json contains { salle: [...], perso: [...] }
      var events = data.salle || data.events || [];
      if (Array.isArray(data) ) events = data;

      var today = new Date();
      var todayStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');

      calEvents = [];
      events.forEach(function(ev) {
        if (!ev.start) return;
        var startDate = new Date(ev.start);
        var endDate = ev.end ? new Date(ev.end) : new Date(startDate.getTime() + 30*60000);

        // Filter today only
        var evDateStr = startDate.getFullYear() + '-' + String(startDate.getMonth()+1).padStart(2,'0') + '-' + String(startDate.getDate()).padStart(2,'0');
        if (evDateStr !== todayStr) return;

        var sh = startDate.getHours();
        var sm = startDate.getMinutes();
        var eh = endDate.getHours();
        var em = endDate.getMinutes();

        calEvents.push({
          title: ev.subject || ev.title || 'Sans titre',
          start: String(sh).padStart(2,'0') + ':' + String(sm).padStart(2,'0'),
          end: String(eh).padStart(2,'0') + ':' + String(em).padStart(2,'0'),
          organizer: ev.organizer || '',
          location: ev.location || ''
        });
      });

      // Sort by start time
      calEvents.sort(function(a, b) { return a.start.localeCompare(b.start); });

      buildCalendar();
    } catch(e) {
      console.error('Calendar load error:', e);
    }
  }

  function buildCalendar() {
    var now = new Date();
    var jours = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
    var mois = ['janv.','f√©v.','mars','avr.','mai','juin','juil.','ao√ªt','sept.','oct.','nov.','d√©c.'];
    document.getElementById('calHeader').textContent = jours[now.getDay()] + ' ' + now.getDate() + ' ' + mois[now.getMonth()];

    var inner = document.getElementById('calTimelineInner');
    inner.innerHTML = '';
    var totalHours = CAL_END - CAL_START;
    inner.style.height = (totalHours * HOUR_HEIGHT) + 'px';

    for (var h = CAL_START; h < CAL_END; h++) {
      var row = document.createElement('div');
      row.className = 'cal-hour-row';
      row.innerHTML = '<span class="cal-hour-label">' + h + 'h</span>';
      row.style.position = 'absolute';
      row.style.top = ((h - CAL_START) * HOUR_HEIGHT) + 'px';
      row.style.left = '0';
      row.style.right = '0';
      row.style.height = HOUR_HEIGHT + 'px';
      inner.appendChild(row);
    }

    var area = document.createElement('div');
    area.className = 'cal-events-area';
    area.style.height = (totalHours * HOUR_HEIGHT) + 'px';
    inner.appendChild(area);

    var nowMinutes = now.getHours() * 60 + now.getMinutes();

    calEvents.forEach(function(ev) {
      var sp = ev.start.split(':');
      var ep = ev.end.split(':');
      var startMin = parseInt(sp[0]) * 60 + parseInt(sp[1]);
      var endMin = parseInt(ep[0]) * 60 + parseInt(ep[1]);
      var topPx = ((startMin - CAL_START * 60) / 60) * HOUR_HEIGHT;
      var heightPx = ((endMin - startMin) / 60) * HOUR_HEIGHT;
      if (heightPx < 24) heightPx = 24;

      var div = document.createElement('div');
      div.className = 'cal-ev';
      if (nowMinutes >= startMin && nowMinutes < endMin) div.classList.add('active');
      if (nowMinutes >= endMin) div.classList.add('past');
      div.style.top = topPx + 'px';
      div.style.height = heightPx + 'px';

      var timeStr = ev.start.replace(':','H') + ' - ' + ev.end.replace(':','H');
      div.innerHTML = '<div class="cal-ev-time">' + timeStr + '</div><div class="cal-ev-title">' + ev.title + '</div>';

      // Tooltip on click
      div.addEventListener('click', function() {
        var info = ev.title + '\n' + timeStr;
        if (ev.organizer) info += '\nOrg: ' + ev.organizer;
        if (ev.location) info += '\nLieu: ' + ev.location;
        alert(info);
      });

      area.appendChild(div);
    });

    // Now line
    if (nowMinutes >= CAL_START * 60 && nowMinutes <= CAL_END * 60) {
      var nowTop = ((nowMinutes - CAL_START * 60) / 60) * HOUR_HEIGHT;
      var line = document.createElement('div');
      line.className = 'cal-now-line';
      line.id = 'calNowLine';
      line.style.top = nowTop + 'px';
      inner.appendChild(line);

      var label = document.createElement('div');
      label.className = 'cal-now-label';
      label.id = 'calNowLabel';
      label.style.top = (nowTop - 6) + 'px';
      var hh = now.getHours();
      var mm = now.getMinutes();
      label.textContent = hh + 'H' + (mm < 10 ? '0' : '') + mm;
      inner.appendChild(label);

      var timeline = document.getElementById('calTimeline');
      setTimeout(function() {
        timeline.scrollTop = Math.max(0, nowTop - 80);
      }, 100);
    }
  }

  function updateNowLine() {
    var now = new Date();
    var nowMinutes = now.getHours() * 60 + now.getMinutes();
    if (nowMinutes < CAL_START * 60 || nowMinutes > CAL_END * 60) return;

    var nowTop = ((nowMinutes - CAL_START * 60) / 60) * HOUR_HEIGHT;
    var line = document.getElementById('calNowLine');
    var label = document.getElementById('calNowLabel');
    if (line) line.style.top = nowTop + 'px';
    if (label) {
      label.style.top = (nowTop - 6) + 'px';
      var hh = now.getHours();
      var mm = now.getMinutes();
      label.textContent = hh + 'H' + (mm < 10 ? '0' : '') + mm;
    }
  }

  // Init calendar
  loadCalendarData();
  setInterval(updateNowLine, 30000);
  // Reload calendar data every 5 min (matches Exchange sync interval)
  setInterval(loadCalendarData, 300000);

</script>
</body>
</html>
